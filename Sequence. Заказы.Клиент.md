@startuml
title Заказы. Со стороны авторизованного пользователя\nдиаграмма прецедентов

actor Авторизованный_пользователь as Клиент
boundary Frontend as Frontend

Клиент -> Frontend : Оформить заказ
Frontend -> MS_Регистрация_и_авторизация : есть личные данные (список)?
MS_Регистрация_и_авторизация --> Frontend : список отсутствующих данных
Frontend -> MS_Корзина : запрос содержимого корзины
MS_Корзина --> Frontend : данные корзины
Frontend --> Клиент  : Форма оформления заказа
Клиент -> Frontend : Ввод недостающих данных
Frontend -> Frontend : Валидация данных

alt данные корректны
Клиент -> Frontend : Запрос на оплату
else данные некорректны
Frontend --> Клиент : Отобразить подсказку
end

note right
Чтобы не усложнять диаграмму,  
цикл не ввожу, но понятно, что 
ввод и валидация повторяются, 
пока всё не будет введено ОК
end note

Frontend -> MS_Регистрация_и_авторизация: личные данные

note right
валидацию на сервере не 
указываю, т.к. это относится к работе 
микросервиса регистрации и авторизации
end note

Frontend -> MS_Заказы: Создать заказ (данные)
MS_Заказы -> MS_Заказы: Создать заказ
MS_Заказы -> Платежная_система: Запрос на оплату (данные)
Платежная_система --> MS_Заказы : Статус оплаты
MS_Заказы --> Frontend: id заказа, статус заказа
Frontend --> Клиент: id заказа, статус заказа
MS_Заказы -> MS_Уведомления: данные заказа
MS_Уведомления -> Клиент: уведомление

loop изменился статус заказа
[o-> MS_Заказы: статус заказа изменен
MS_Заказы --> Frontend: статус заказа
Frontend --> Клиент: новый статус заказа
MS_Заказы -> MS_Заказы: проверить статус заказа 

note right
Уведомление пользователю направляется,
только если заказ принят рестораном или 
отменен. В остальных случаях - изменение
статуса просто отображается на Frontend
end note

alt заказ отменен
MS_Заказы <->o MS_Доставка : заказ (id) отменен, причина (id)
note right
Связь двусторонняя, т.к.
MS_Заказы -> MS_Доставка, 
если заказ отменил клиент или ресторан
MS_Заказы <- MS_Доставка, 
если заказ отменен из-за отсутствия курьеров
end note
MS_Заказы -> MS_Уведомления: заказ (id) отменен, причина (id)
MS_Заказы -> MS_Оплата : запрос на возврат средств
MS_Уведомления -> Клиент: уведомление об отмене
else заказ принят рестораном
MS_Заказы -> MS_Уведомления: заказ (id) принят
MS_Уведомления -> Клиент: уведомление
end

end

opt клиент отменяет оплаченный заказ 
Клиент -> Frontend : отменить заказ
Frontend -> MS_Заказы : заказ (id) отменить
MS_Заказы -> MS_Заказы : изменить статус заказа (id)
end

opt клиент хочет изменить заказ 
Клиент -> Frontend : изменить заказ
Frontend -> MS_Заказы : заказ (id) можно изменить?
MS_Заказы -> MS_Заказы : ресторан принял заказ?
alt ресторан уже принял заказ
MS_Заказы --> Frontend : заказ (id) изменить нельзя
Frontend --> Клиент : изменить заказ невозможно
else ресторан еще не принял заказ
MS_Заказы --> Frontend : заказ (id) можно изменить 
Frontend --> Клиент : дать доступ на изменение заказа 
Клиент -> Frontend : изменить состав заказа 
Frontend -> MS_Заказы : новые данные заказа (id)
MS_Заказы -> MS_Заказы : обновить заказ (id)
end
end
@enduml